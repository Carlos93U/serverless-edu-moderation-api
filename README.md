# Serverless Edu Moderation API

A serverless image‐moderation API for educational platforms, built with **AWS Rekognition**, **Lambda**, **API Gateway**, and **Terraform**. It automatically detects unsafe or inappropriate content to maintain a secure learning environment.

---

## 1. Goal

The goal is to automatically evaluate uploaded images and determine whether they are safe for use in school or academic environments. The system analyzes images using **Amazon Rekognition Moderation Labels** and classifies them into three categories:

- **LOW Risk** → Safe
- **MEDIUM Risk** → Requires manual review
- **HIGH Risk** → Blocked

---

## 2. Use Case: Educational Platform Moderation

This API integrates with LMS systems (Moodle, Blackboard, Google Classroom clones, etc.) to:

- Validate **student profile photos**
- Moderate **uploaded assignments**
- Review **forum & chat images**
- Protect minors from exposure to harmful material

---

## 3. Architecture

The architecture follows the same principles from the chapter's serverless solution, updated for content moderation:

<p align="center">
  <img src="assets/arch.gif" alt="Architecture Diagram">
</p>

Detailed flow description and examples for each step

## 1a / 1b / 1c / 1d — Request origins

### 1a – Local application or script
A user sends an image from Postman, cURL, or a frontend.

**Example request (POST):**
```json
{
  "image_base64": "<string-base64>",
  "filename": "photo1.jpg"
}
```

### 1b – External applications within AWS
Microservices (ECS, Lambda, EC2) that send images to the REST endpoint.

**Example:**
```python
import requests
requests.post(API_URL, json={"image_base64": img})
```

### 1c – Applications on Azure
Services like Azure Functions or App Services consume the public API.

### 1d – Apps on other clouds or external systems
External services, Google Cloud, on-premise servers, mobile apps, etc.

All these clients send data over the **Internet**, primarily using JSON + base64.

---

## 2 — Entry to Amazon API Gateway
The endpoint receives:
- HTTP method (POST)
- JSON payload
- headers

**Example:**
```
POST https://xxxxxxx.execute-api.aws.com/dev/moderate
```

If the JSON is invalid → returns `400 Bad Request`.

---

## 3 — Routing to the API Stage (/dev or /prod)
The Stage defines:
- throttling
- size limits
- environment variables

**Example of Lambda event generated by API Gateway:**
```json
{
  "body": "{\"image_base64\":\"<string-base64>\", \"filename\":\"photo1.jpg\"}",
  "httpMethod": "POST",
  "path": "/moderate",
  "headers": { }
}
```

---

## 4 — AWS Lambda invocation
Lambda processes:
1. Read the body.
2. Decode base64.
3. Validate size and type.
4. Prepare the request for Rekognition.

**Example:**
```python
import base64
image_bytes = base64.b64decode(event_body["image_base64"])
```

**Example of error:**
```json
{
  "error": "ImageTooLarge",
  "message": "The image exceeds the maximum allowed size (5MB)"
}
```

---

## 5 — Lambda call → Amazon Rekognition
```python
rekognition.detect_moderation_labels(
    Image={"Bytes": image_bytes},
    MinConfidence=75
)
```

---

## 6 — Processing in Amazon Rekognition
Rekognition evaluates inappropriate content.

**Example response:**
```json
{
  "ModerationLabels": [
    {
      "Name": "Explicit Nudity",
      "ParentName": "",
      "Confidence": 94.2
    },
    {
      "Name": "Nudity",
      "ParentName": "Explicit Nudity",
      "Confidence": 88.9
    }
  ]
}
```

---

## 7 — Lambda receives and processes the response
Transforms the output into a clean format.

**Example:**
```json
{
  "result": "rejected",
  "reason": "The image contains explicit nudity.",
  "labels": [
    {"label": "Explicit Nudity", "confidence": 94.2},
    {"label": "Nudity", "confidence": 88.9}
  ]
}
```

**If the image is safe:**
```json
{
  "result": "approved",
  "labels": []
}
```

---

## 8 — Lambda response → API Gateway
```json
{
  "statusCode": 200,
  "body": "{\"result\":\"approved\"}"
}
```

---

## 9 — API Gateway responds to the end client
Final response received by any external application.

**Example of approved response:**
```json
{
  "result": "approved",
  "labels": []
}
```

**Example of rejected content:**
```json
{
  "result": "rejected",
  "reason": "Explicit content detected",
  "labels": [
    { "label": "Explicit Nudity", "confidence": 94.2 }
  ]
}
```
---
## 10 — AWS CloudWatch Logs


- To review dasboards and logs


---

## 4. Features

- Serverless and pay‑per‑use
- Moderation label detection using Rekognition
- Accepts base64‑encoded images
- Returns structured JSON for frontend or backend systems

---

## 5. How It Works

### **5.1. Requirements Definition**

- Must detect inappropriate image content
- Must not store personal images
- Must handle multiple client apps
- Must be low‑cost and scalable

### **5.2. Architecture Selection**

Chosen approach: **pre‑trained managed model with Amazon Rekognition**.

### **5.3. Infrastructure Deployment (Terraform)**

Terraform provisions:

- Lambda function
- IAM roles with Rekognition & CloudWatch permissions
- REST API Gateway
- Lambda permissions for invocation

### **5.4. Lambda Implementation (Python)**

- Accepts base64 payload
- Calls Rekognition DetectModerationLabels
- Applies risk‑classification logic
- Returns JSON response

### **5.5. Testing Locally**

You may test via:

- Running the handler locally
- Using AWS SAM CLI
- Sending requests through Postman with base64 images

### **5.6. Deployment**

Run:

```
terraform apply
```

Terraform outputs the API invoke URL.

---

## 6. Project Folder Structure

A clean and organized structure adapted for Terraform + Lambda:

```
serverless-edu-moderation-api/
├── terraform/
│   ├── lambda.tf
│   ├── apigw.tf
│   ├── variables.tf
├── python/
│   ├── moderation.py
│   └── moderation.zip   (auto‑generated)
├── assets/
├── README.md
└── .gitignore
```

---

## 7. Deploying with Terraform

Follow these steps to deploy the API into AWS.

### **7.1. Configure AWS credentials**

Ensure AWS CLI is authenticated:

```bash
aws configure
```

### **7.2. Navigate to the Terraform directory**

```bash
cd terraform
```

### **7.3. Initialize Terraform**

```bash
terraform init
```

### **7.4. Validate configuration**

```bash
terraform validate
```

### **7.5. Deploy infrastructure**

```bash
terraform apply
```

Confirm with **yes** when prompted.

### **7.6. Retrieve API URL**

Terraform will output something like:

```
https://abcd1234.execute-api.us-east-1.amazonaws.com/dev/moderate
```

This is your production endpoint.

### **7.7. Destroy resources when done**

To delete all the resources you just created, run:

```bash
terraform destroy
```

---

## 8. Estimated Monthly Costs

The following table summarizes the estimated monthly costs for this architecture assuming an average of **9,000 image moderation inferences per month** (based on 200 students uploading 2 images per day, 5 days per week, plus a 1,000-image buffer).

### **8.1. Amazon Rekognition – Content Moderation**
- Pricing: **$0.0010 USD per image**
- Calculation:
  ```
  9,000 images × $0.0010 = $9.00 USD/month
  ```

### **8.2. AWS Lambda**
Assumptions:
- 128 MB memory  
- ~250 ms average execution  
- 9,000 invocations per month  
- Lambda free tier covers the first 1M requests  

Compute cost:
```
Cost per execution ≈ $0.00000052
9,000 executions ≈ $0.00468 USD/month
```
Total Lambda cost: **~$0.005 USD/month**

### **8.3. Amazon API Gateway (REST API)**
- Pricing: **$3.50 per 1 million requests**
- Calculation:
  ```
  9,000 requests ≈ 0.009M
  0.009 × $3.50 = $0.0315 USD/month
  ```

---

### **Monthly Cost Summary**

| Service                    | Unit Price                     | Monthly Usage | Estimated Monthly Cost |
|----------------------------|--------------------------------|---------------|--------------------------|
| **Rekognition (Moderation)** | $0.0010 per image              | 9,000 images  | **$9.00**                |
| **AWS Lambda**              | ~$0.00000052 per invocation    | 9,000 calls   | **$0.005**               |
| **API Gateway (REST)**      | $3.50 per 1M requests          | 9,000 calls   | **$0.03**                |
| **Total Estimated Cost**    | —                              | —             | **~$9.03 USD/month**     |

If you check this calculos go to AWS princing calculator link fot this project 
- [Check Calculus](https://calculator.aws/#/estimate?id=c7d02b80e9e0a056c0a1c440bd131cd826209091)

### **Summary**
The entire serverless content‑moderation pipeline operates for **under $10 USD per month**, with the vast majority of cost coming from **Rekognition**. Lambda and API Gateway contribute only a few cents.
