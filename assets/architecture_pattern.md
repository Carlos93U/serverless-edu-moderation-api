# Architecture

The architecture follows the same principles from the chapter's serverless solution, updated for content moderation:

<p align="center">
  <img src="arch.gif" alt="Architecture Diagram">
</p>

Detailed flow description and examples for each step

## 1. 1a / 1b / 1c / 1d — Request origins

### 1a – Local application or script
A user sends an image from Postman, cURL, or a frontend.

**Example request (POST):**
```json
{
  "image_base64": "<string-base64>",
  "filename": "photo1.jpg"
}
```

### 1b – External applications within AWS
Microservices (ECS, Lambda, EC2) that send images to the REST endpoint.

**Example:**
```python
import requests
requests.post(API_URL, json={"image_base64": img})
```

### 1c – Applications on Azure
Services like Azure Functions or App Services consume the public API.

### 1d – Apps on other clouds or external systems
External services, Google Cloud, on-premise servers, mobile apps, etc.

All these clients send data over the **Internet**, primarily using JSON + base64.

---

## 2 — Entry to Amazon API Gateway
The endpoint receives:
- HTTP method (POST)
- JSON payload
- headers

**Example:**
```
POST https://xxxxxxx.execute-api.aws.com/dev/moderate
```

If the JSON is invalid → returns `400 Bad Request`.

---

## 3 — Routing to the API Stage (/dev or /prod)
The Stage defines:
- throttling
- size limits
- environment variables

**Example of Lambda event generated by API Gateway:**
```json
{
  "body": "{\"image_base64\":\"<string-base64>\", \"filename\":\"photo1.jpg\"}",
  "httpMethod": "POST",
  "path": "/moderate",
  "headers": { }
}
```

---

## 4 — AWS Lambda invocation
Lambda processes:
1. Read the body.
2. Decode base64.
3. Validate size and type.
4. Prepare the request for Rekognition.

**Example:**
```python
import base64
image_bytes = base64.b64decode(event_body["image_base64"])
```

**Example of error:**
```json
{
  "error": "ImageTooLarge",
  "message": "The image exceeds the maximum allowed size (5MB)"
}
```

---

## 5 — Lambda call → Amazon Rekognition
```python
rekognition.detect_moderation_labels(
    Image={"Bytes": image_bytes},
    MinConfidence=75
)
```

---

## 6 — Processing in Amazon Rekognition
Rekognition evaluates inappropriate content.

**Example response:**
```json
{
  "ModerationLabels": [
    {
      "Name": "Explicit Nudity",
      "ParentName": "",
      "Confidence": 94.2
    },
    {
      "Name": "Nudity",
      "ParentName": "Explicit Nudity",
      "Confidence": 88.9
    }
  ]
}
```

---

## 7 — Lambda receives and processes the response
Transforms the output into a clean format.

**Example:**
```json
{
  "result": "rejected",
  "reason": "The image contains explicit nudity.",
  "labels": [
    {"label": "Explicit Nudity", "confidence": 94.2},
    {"label": "Nudity", "confidence": 88.9}
  ]
}
```

**If the image is safe:**
```json
{
  "result": "approved",
  "labels": []
}
```

---

## 8 — Lambda response → API Gateway
```json
{
  "statusCode": 200,
  "body": "{\"result\":\"approved\"}"
}
```

---

## 9 — API Gateway responds to the end client
Final response received by any external application.

**Example of approved response:**
```json
{
  "result": "approved",
  "labels": []
}
```

**Example of rejected content:**
```json
{
  "result": "rejected",
  "reason": "Explicit content detected",
  "labels": [
    { "label": "Explicit Nudity", "confidence": 94.2 }
  ]
}
```
---
## 10 — AWS CloudWatch Logs
To review dasboards and logs

